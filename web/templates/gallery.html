{% extends "base.html" %}

{% block content %}

<style>
/* ===== BALENCIAGA GALLERY STYLE (HIGH CONTRAST FIX) ===== */

body {
    background: #050505;
}

/* Header */
.gallery-header {
    margin-bottom: 3rem;
}

.gallery-header h2 {
    font-size: 1.1rem;
    letter-spacing: 0.35em;
    text-transform: uppercase;
    opacity: 1;
    color: #f2f2f2;
}

/* Grid */
.gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 3rem;
}

/* Item */
.gallery-item {
    aspect-ratio: 3 / 4;
    background: #0d0d0d;
    overflow: hidden;
    cursor: pointer;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.06);
}

.gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: brightness(0.9) contrast(1.05);
    transition: filter 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
    opacity: 0;
}

.gallery-item img.is-loaded {
    opacity: 1;
}
.gallery-item:hover img {
    filter: brightness(1.05) contrast(1.1);
    transform: scale(1.01);
}

/* Pagination */
.pagination {
    display: flex;
    justify-content: space-between;
    margin-top: 4rem;
}

.pagination a {
    font-size: 0.7rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: #e5e5e5;
    opacity: 0.9;
    text-decoration: none;
}

.pagination .page-disabled {
    font-size: 0.7rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: #e5e5e5;
    opacity: 0.25;
    pointer-events: none;
}

.pagination a:hover {
    opacity: 1;
}

/* ===== LIGHTBOX ===== */

.lightbox {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.96);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.lightbox.active {
    display: flex;
}

.lightbox img {
    max-width: 90vw;
    max-height: 85vh;
    object-fit: contain;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.15);
}

/* Controls */
.lightbox-controls {
    position: fixed;
    bottom: 3rem;
    display: flex;
    gap: 1.5rem;
}

.lightbox-controls button {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.6);
    color: #ffffff;
    font-size: 0.7rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    padding: 0.55rem 1rem;
    cursor: pointer;
}

.lightbox-controls button:hover {
    background: rgba(255,255,255,0.1);
    border-color: #ffffff;
}

.lightbox-hints {
    position: fixed;
    top: 1.25rem;
    right: 1.5rem;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    opacity: 0.55;
}

.empty-state {
    border: 1px dashed rgba(255,255,255,0.15);
    padding: 2rem;
    text-align: center;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    font-size: 0.7rem;
    opacity: 0.6;
}
</style>


<div class="gallery-header">
    <h2>{{ model_name }}</h2>
</div>

{% if media %}
    <div class="gallery-grid">
        {% for item in media %}
            <div
                class="gallery-item"
                data-index="{{ loop.index0 }}"
                data-id="{{ item.id }}"
            >
                <img src="{{ item.url }}" loading="lazy">
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state">No media yet</div>
{% endif %}

<nav class="pagination">
    {% if has_prev %}
        <a href="?page={{ page - 1 }}{{ page_token_query }}">← Prev</a>
    {% else %}
        <span class="page-disabled">← Prev</span>
    {% endif %}
    {% if has_next %}
        <a href="?page={{ page + 1 }}{{ page_token_query }}">Next →</a>
    {% else %}
        <span class="page-disabled">Next →</span>
    {% endif %}
</nav>

<!-- LIGHTBOX -->
<div id="lightbox" class="lightbox">
    <img id="lightboxImage">
    <div class="lightbox-hints">←/→ Next • Esc Close • Delete</div>
    <div class="lightbox-controls">
        <button onclick="deleteCurrent()">Delete</button>
        <button onclick="closeLightbox()">Close</button>
    </div>
</div>

<script>
const media = {{ media | tojson }};
const adminToken = "{{ token }}";
const deleteTokenQuery = adminToken ? `?token=${encodeURIComponent(adminToken)}` : "";
let currentIndex = 0;

const lightbox = document.getElementById("lightbox");
const lightboxImage = document.getElementById("lightboxImage");

document.querySelectorAll(".gallery-item").forEach(item => {
    item.addEventListener("click", () => {
        currentIndex = Number(item.dataset.index);
        openLightbox();
    });
});

document.querySelectorAll(".gallery-item img").forEach((img) => {
    if (img.complete) {
        img.classList.add("is-loaded");
    } else {
        img.addEventListener("load", () => img.classList.add("is-loaded"));
    }
});

function openLightbox() {
    lightboxImage.src = media[currentIndex].url;
    lightbox.classList.add("active");
}

function closeLightbox() {
    lightbox.classList.remove("active");
}

function nextImage() {
    currentIndex = (currentIndex + 1) % media.length;
    openLightbox();
}

function prevImage() {
    currentIndex = (currentIndex - 1 + media.length) % media.length;
    openLightbox();
}

function deleteCurrent() {
    const id = media[currentIndex].id;
    if (!confirm("Delete this image?")) return;

    fetch(`/api/media/${id}${deleteTokenQuery}`, {
        method: "DELETE",
        headers: adminToken ? { "X-Admin-Token": adminToken } : {}
    })
        .then(res => {
            if (res.ok) location.reload();
            else alert("Delete failed");
        });
}

document.addEventListener("keydown", e => {
    if (!lightbox.classList.contains("active")) return;

    if (e.key === "ArrowRight") nextImage();
    if (e.key === "ArrowLeft") prevImage();
    if (e.key === "Escape") closeLightbox();
});
</script>

{% endblock %}
